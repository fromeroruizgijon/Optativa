<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${proyecto.nombre}"></title>
    <link rel="stylesheet" href="/css/proyecto.css">
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">← Volver al Inicio</a>

        <header class="project-hero">
            <div class="project-title-row">
                <div>
                    <h1 th:text="${proyecto.nombre}"></h1>
                    <p class="hero-desc" th:text="${proyecto.descripcion}"></p>
                </div>
                <a th:href="@{/descargarPdf(id=${proyecto.id})}" target="_blank" class="btn-action btn-secondary">
                    Descargar PDF
                </a>
            </div>
            <div style="margin-top: 2rem;">
                <div style="display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase; font-size: 0.85rem; color: #475569;">
                    <span>Estado del Proyecto</span>
                    <span th:text="${#numbers.formatDecimal(proyecto.porcentajeCompletado, 0, 0)} + '% Completado'"></span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" 
                        th:style="'width:' + ${proyecto.porcentajeCompletado} + '%'">
                    </div>
                </div>
            </div>
        </header>

        <section>
            <div class="tasks-section-header">
                <h2>Tareas</h2>
                <div style="display: flex; gap: 1rem;">
                     <a th:href="@{/proyecto/ordenarPrioridad(nombre=${proyecto.nombre})}" class="btn-action btn-secondary" style="font-size: 0.8rem;">Ordenar por Prioridad</a>
                    <button class="btn-action btn-toggle-form" data-target="mainTaskForm">+ Nueva Tarea</button>
                </div>
            </div>
            
            <div id="mainTaskForm" class="hidden-form-container">
                <form th:action="@{/insertarTareaPrincipal}" method="get" class="form-inline-flex">
                    <input type="hidden" name="idProyecto" th:value="${proyecto.id}">
                    <input type="text" name="titulo" class="form-input" placeholder="Título" required>
                    <input type="text" name="descripcion" class="form-input" placeholder="Descripción" required>
                    <input type="number" name="prioridad" class="form-input form-input-sm" placeholder="Prio" value="1" min="1" required>
                    <input type="submit" value="Añadir" class="btn-action">
                </form>
            </div>
            <div th:each="tarea : ${proyecto.soloTareasPrincipales}" class="task-block" th:classappend="${tarea.estado} ? 'task-completed' : ''">
                <div class="task-main-row">
                    <div class="task-info">
                        <form th:action="@{/cambiarEstadoTarea}" method="get">
                            <input type="hidden" name="idTarea" th:value="${tarea.id}">
                            
                            <input type="checkbox" name="estado" value="true" 
                                th:checked="${tarea.estado}" 
                                class="auto-submit-check">
                        </form>
                        
                        <div>
                            <div class="task-title" th:text="${tarea.titulo}"></div>
                            <small th:text="${tarea.description}" style="color: #64748b;"></small>
                        </div>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1.5rem;">
                        <span class="priority-badge">Prioridad <span th:text="${tarea.prioridad}"></span></span>
                        <a th:href="@{/borrarTarea(id=${tarea.id}, nombreProyecto=${proyecto.nombre})}" 
                           class="btn-text-delete"
                           onclick="return confirm('¿Borrar tarea?')">Borrar</a>
                    </div>
                </div>

                <div class="subtasks-container">
                    <div th:each="sub : ${tarea.tareasSecundarias}" class="subtask-row">
                        <div style="display: flex; gap: 10px; align-items: center;">
                             <span style="color: #cbd5e1;">↳</span>
                             <span th:text="${sub.titulo}" style="font-weight: 500;"></span>
                             <small style="color: #94a3b8;" th:text="'(' + ${sub.description} + ')'"></small>
                        </div>
                        <a th:href="@{/borrarTarea(id=${sub.id}, nombreProyecto=${proyecto.nombre})}" class="btn-text-delete" style="font-size: 0.8rem;">Eliminar</a>
                    </div>
                    
                    <button class="btn-text-toggle btn-toggle-form" th:data-target="${'subForm-' + tarea.id}">+ Añadir Subtarea</button>
                    
                    <div th:id="${'subForm-' + tarea.id}" class="hidden-form-container" style="background: #fff;">
     
                        <form th:action="@{/insertarTareaSecundaria}" method="get" class="form-inline-flex">
                            <input type="hidden" name="idProyecto" th:value="${proyecto.id}">
                            <input type="hidden" name="idTareaPadre" th:value="${tarea.id}">
                            <input type="text" name="tituloSecundaria" class="form-input" placeholder="Título" required>
                            <input type="text" name="descripcion" class="form-input" placeholder="Descripción" required>
                            <input type="number" name="prioridad" class="form-input form-input-sm" value="1" required>
                            <input type="text" name="categoria" class="form-input form-input-sm" placeholder="Cat.">
                            <input type="submit" value="Guardar" class="btn-action btn-secondary">
                        </form>
                    </div>
                </div>
            </div>
        </section>
    </div>
    <script src="/js/scripts.js"></script>
</body>
</html>